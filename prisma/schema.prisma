// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id                    String        @id @default(cuid())
  email                 String?       @unique
  name                  String?
  password              String?       // Hashed password (nullable for future OAuth)
  role                  UserRole      @default(USER)
  isPremium             Boolean       @default(false)
  emailVerified         Boolean       @default(false)
  emailVerificationToken String?
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  banks                 QuestionBank[]
  sessions              Session[]
  quizzes               Quiz[]
  learningSummaries     LearningSummary[]
  learningInsights      UserLearningInsight?
  bankFolders           BankFolder[]
}

model QuestionBank {
  id          String           @id @default(cuid())
  userId      String?
  title       String
  order       Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  user        User?            @relation(fields: [userId], references: [id])
  questions   Question[]
  quizzes     Quiz[]
  sessions    Session[]
  folderItems BankFolderItem[]
}

model BankFolder {
  id        String           @id @default(cuid())
  userId    String
  title     String
  color     String?
  order     Int              @default(0)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     BankFolderItem[]

  @@index([userId, order])
}

model BankFolderItem {
  id       String       @id @default(cuid())
  folderId String
  bankId   String
  order    Int          @default(0)
  folder   BankFolder   @relation(fields: [folderId], references: [id], onDelete: Cascade)
  bank     QuestionBank @relation(fields: [bankId], references: [id], onDelete: Cascade)

  @@unique([folderId, bankId])
  @@index([folderId, order])
  @@index([bankId])
}

enum QuestionType {
  BEHAVIORAL
  TECHNICAL
  DEFINITION
  SCENARIO
  PITCH
}

model Question {
  id         String       @id @default(cuid())
  bankId     String
  text       String
  hint       String?      // Optional answer/hint text from CSV back field
  tags       String[]     // e.g. ["leadership","system-design"]
  difficulty Int          // 1..5
  type       QuestionType @default(BEHAVIORAL) // Auto-detected or user-specified
  bank       QuestionBank @relation(fields: [bankId], references: [id])
  items      SessionItem[]
  quizAttempts QuizAttempt[]

  @@index([bankId])
}

model Session {
  id          String            @id @default(cuid())
  userId      String?
  title       String
  bankId      String?
  filterTags  String[]          @default([]) // Tags to filter questions by (for weak topics practice)
  isCompleted Boolean           @default(false)
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  user        User?             @relation(fields: [userId], references: [id])
  bank        QuestionBank?     @relation(fields: [bankId], references: [id])
  items       SessionItem[]
  summary     LearningSummary?

  @@index([userId, createdAt])
}

model SessionItem {
  id                String   @id @default(cuid())
  sessionId         String
  questionId        String
  audioUrl          String?
  transcript        String?
  words             Int?
  wpm               Int?
  fillerCount       Int?
  fillerRate        Float?   // per 100 words
  longPauses        Int?     // >800ms
  confidenceScore   Float?   // 0..5 (vocal confidence, 0.5 steps)
  intonationScore   Float?   // 0..5 (pitch variation, expressiveness, 0.5 steps)
  starScore         Float?   // 0..5 (0.5 steps)
  impactScore       Float?   // 0..5 (0.5 steps)
  clarityScore      Float?   // 0..5 (0.5 steps)
  technicalAccuracy Float?   // 0..5 (0.5 steps)
  terminologyUsage  Float?   // 0..5 (0.5 steps)
  questionAnswered  Boolean? // Did the answer address the question?
  answerQuality     Float?   // 0..5 overall answer quality (0.5 steps)
  whatWasRight      String[] // Array of what was right
  whatWasWrong      String[] // Array of what needs improvement
  betterWording     String[] // Array of better wording suggestions (with definitions, examples, clarity)
  dontForget        String[] // Array of important points they forgot to mention
  aiFeedback        String?
  createdAt         DateTime @default(now())
  session           Session  @relation(fields: [sessionId], references: [id])
  question          Question @relation(fields: [questionId], references: [id])

  @@index([sessionId])
}

model Quiz {
  id          String      @id @default(cuid())
  userId      String?
  title       String
  description String?
  type        QuizType    @default(SPOKEN) // SPOKEN or WRITTEN
  bankId      String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User?       @relation(fields: [userId], references: [id])
  bank        QuestionBank? @relation(fields: [bankId], references: [id])
  attempts    QuizAttempt[]
}

enum QuizType {
  SPOKEN
  WRITTEN
}

model QuizAttempt {
  id          String   @id @default(cuid())
  quizId      String
  questionId  String
  answer      String?  // Written answer or transcript
  audioUrl    String?  // For spoken quizzes
  transcript  String?  // For spoken quizzes
  score       Float?   // 0..100
  feedback    String?
  hintUsed    Boolean  @default(false) // Whether the user viewed the hint for this question
  startedAt   DateTime @default(now())
  completedAt DateTime?
  quiz        Quiz     @relation(fields: [quizId], references: [id])
  question    Question @relation(fields: [questionId], references: [id])

  @@index([quizId])
}

model LearningSummary {
  id              String   @id @default(cuid())
  userId          String
  sessionId       String   @unique
  bankId          String?
  commonMistakes  Json     // Array of mistake patterns
  frequentlyForgottenPoints Json? // Array of key points consistently forgotten
  weakTags        String[] // Tags with low scores
  strongTags      String[] // Tags with high scores
  recommendedFocus String[] // Tags to revisit
  performanceByTag Json     // Tag -> avg score mapping
  overallScore    Float?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserLearningInsight {
  id                  String   @id @default(cuid())
  userId              String   @unique
  aggregatedWeakTags  String[] // Across all sessions
  aggregatedStrongTags String[] // Across all sessions
  topFocusAreas       String[] // Most recommended
  topForgottenPoints  Json?    // Most frequently forgotten key points across all sessions
  totalSessions       Int      @default(0)
  totalQuestions      Int      @default(0)
  lastUpdated         DateTime @default(now()) @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}